#!/bin/bash
#SBATCH --job-name=LP3
#SBATCH --output=LP3.out
#SBATCH --error=LP3.err
#SBATCH --partition=128x24
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=40G
#SBATCH --time=3-00:00:00

########################################
# Load environment
########################################

module load perl

export PATH="$HOME/perl5/bin:$PATH"
export PERL5LIB="$HOME/perl5/lib/perl5:$PERL5LIB"

# Test module
perl -MText::NSP::Measures::2D::Fisher::twotailed -e 'print "Perl module works\n"'

export LC_ALL=C
export LANG=C

set -euo pipefail
set -x

########################################
# Paths
########################################

WORKDIR=/hb/groups/kay_lab/popoolation2/populations/LP3
POPDIR=/hb/groups/kay_lab/popoolation2/populations/LP2/popoolation2_1201

cd "$WORKDIR"

[[ -f p3p_p3w.sync ]] || { echo "Missing sync file"; exit 1; }

########################################
# STEP 5 — FST WINDOWS
########################################

echo "Starting FST calculation $(date)"

for WS in 1 500; do

    if [[ $WS -eq 500 ]]; then
        OUT=p3p_p3w_w500
    else
        OUT=p3p_p3w
    fi

    if [[ ! -s ${OUT}.fst ]]; then
        perl "$POPDIR"/fst-sliding.pl \
            --input p3p_p3w.sync \
            --output ${OUT}.fst \
            --suppress-noninformative \
            --min-count 6 \
            --min-coverage 50 \
            --max-coverage 200 \
            --min-covered-fraction 1 \
            --window-size $WS \
            --step-size $WS \
            --pool-size 100
    fi
done

########################################
# STEP 6 — EXPORT FST → IGV
########################################

for OUT in p3p_p3w p3p_p3w_w500; do
    if [[ ! -s ${OUT}.igv ]]; then
        perl "$POPDIR"/export/pwc2igv.pl \
            --input ${OUT}.fst \
            --output ${OUT}.igv
    fi
done

########################################
# STEP 7 — FISHER TEST
########################################

echo "Starting Fisher test $(date)"

if [[ ! -s p3p_p3w.fet ]]; then
    perl "$POPDIR"/fisher-test.pl \
        --input  p3p_p3w.sync \
        --output p3p_p3w.fet \
        --min-count 6 \
        --min-coverage 50 \
        --max-coverage 200 \
        --suppress-noninformative
fi

if [[ ! -s p3p_p3w_fet.igv ]]; then
    perl "$POPDIR"/export/pwc2igv.pl \
        --input  p3p_p3w.fet \
        --output p3p_p3w_fet.igv
fi

echo "Pipeline complete $(date)"

