#!/bin/bash
#SBATCH --job-name=LP2
#SBATCH --output=LP2.out
#SBATCH --error=LP2.err
#SBATCH --partition=long
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=40G
#SBATCH --time=7-00:00:00

########################################
# Load environment
########################################

source /private/groups/kaylab/aschjeld/setup_conda.sh
conda activate popoolation2

export PATH="$HOME/perl5/bin:$PATH"
export PERL5LIB="$HOME/perl5/lib/perl5:$PERL5LIB"

export LC_ALL=C
export LANG=C

set -euo pipefail
set -x

########################################
# Paths
########################################

WORKDIR=/private/groups/kaylab/popoolation2/populations/gi/LP2
POPDIR=$WORKDIR/popoolation2_1201
SYNC=p2p_p2w.sync

cd "$WORKDIR"

########################################
# STEP 4 — BAM → SYNC (piped, no mpileup file)
########################################

if [[ ! -s $SYNC ]]; then

    echo "Creating sync file $(date)"

    samtools mpileup \
        -B \
        -d 1000 \
        -f ref/refgenome.fa \
        pmerged/pop2p_sorted.bam \
        wmerged/pop2w_sorted.bam \
    | java -ea -Xmx28g -jar "$POPDIR/mpileup2sync.jar" \
        --input - \
        --output $SYNC \
        --fastq-type sanger \
        --min-qual 20 \
        --threads 16

fi

########################################
# STEP 5 — FST WINDOWS
########################################

echo "Starting FST $(date)"

for WS in 1 500; do

    if [[ $WS -eq 500 ]]; then
        OUT=p2p_p2w_w500
    else
        OUT=p2p_p2w
    fi

    if [[ ! -s ${OUT}.fst ]]; then
        perl "$POPDIR/fst-sliding.pl" \
            --input $SYNC \
            --output ${OUT}.fst \
            --suppress-noninformative \
            --min-count 6 \
            --min-coverage 50 \
            --max-coverage 200 \
            --min-covered-fraction 1 \
            --window-size $WS \
            --step-size $WS \
            --pool-size 100
    fi
done

########################################
# STEP 6 — EXPORT FST → IGV
########################################

for OUT in p2p_p2w p2p_p2w_w500; do
    if [[ ! -s ${OUT}.igv ]]; then
        perl "$POPDIR/export/pwc2igv.pl" \
            --input ${OUT}.fst \
            --output ${OUT}.igv
    fi
done

########################################
# STEP 7 — FISHER TEST
########################################

echo "Starting Fisher $(date)"

if [[ ! -s p2p_p2w.fet ]]; then
    perl "$POPDIR/fisher-test.pl" \
        --input  $SYNC \
        --output p2p_p2w.fet \
        --min-count 6 \
        --min-coverage 50 \
        --max-coverage 200 \
        --suppress-noninformative
fi

if [[ ! -s p2p_p2w_fet.igv ]]; then
    perl "$POPDIR/export/pwc2igv.pl" \
        --input  p2p_p2w.fet \
        --output p2p_p2w_fet.igv
fi

echo "Pipeline complete $(date)"

