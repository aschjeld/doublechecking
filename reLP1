#!/bin/bash
#SBATCH --job-name=LP1
#SBATCH --output=LP1.out
#SBATCH --error=LP1.err
#SBATCH --partition=128x24
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=40G
#SBATCH --time=3-00:00:00

########################################
# Load environment
########################################

module load perl
module load samtools
module load java

export PATH="$HOME/perl5/bin:$PATH"
export PERL5LIB="$HOME/perl5/lib/perl5:$PERL5LIB"

export LC_ALL=C
export LANG=C

set -euo pipefail
set -x

########################################
# Paths
########################################

WORKDIR=/hb/groups/kay_lab/popoolation2/populations/LP1
POPDIR=$WORKDIR/popoolation2_1201
SYNC=p1p_p1w.sync

cd "$WORKDIR"

########################################
# STEP 4 — BAM → SYNC (piped, no mpileup file)
########################################

if [[ ! -s $SYNC ]]; then

    echo "Creating sync file $(date)"

    samtools mpileup \
        -B \
        -d 1000 \
        -f ref/refgenome.fa \
        map/pop1p.sorted.bam \
        map/pop1w.sorted.bam \
    | java -ea -Xmx28g -jar "$POPDIR/mpileup2sync.jar" \
        --input - \
        --output $SYNC \
        --fastq-type sanger \
        --min-qual 20 \
        --threads 16

fi

########################################
# STEP 5 — FST WINDOWS
########################################

echo "Starting FST $(date)"

for WS in 1 500; do

    if [[ $WS -eq 500 ]]; then
        OUT=p1p_p1w_w500
    else
        OUT=p1p_p1w
    fi

    if [[ ! -s ${OUT}.fst ]]; then
        perl "$POPDIR/fst-sliding.pl" \
            --input $SYNC \
            --output ${OUT}.fst \
            --suppress-noninformative \
            --min-count 6 \
            --min-coverage 50 \
            --max-coverage 200 \
            --min-covered-fraction 1 \
            --window-size $WS \
            --step-size $WS \
            --pool-size 58
    fi
done

########################################
# STEP 6 — EXPORT FST → IGV
########################################

for OUT in p1p_p1w p1p_p1w_w500; do
    if [[ ! -s ${OUT}.igv ]]; then
        perl "$POPDIR/export/pwc2igv.pl" \
            --input ${OUT}.fst \
            --output ${OUT}.igv
    fi
done

########################################
# STEP 7 — FISHER TEST
########################################

echo "Starting Fisher $(date)"

if [[ ! -s p1p_p1w.fet ]]; then
    perl "$POPDIR/fisher-test.pl" \
        --input  $SYNC \
        --output p1p_p1w.fet \
        --min-count 6 \
        --min-coverage 50 \
        --max-coverage 200 \
        --suppress-noninformative
fi

if [[ ! -s p1p_p1w_fet.igv ]]; then
    perl "$POPDIR/export/pwc2igv.pl" \
        --input  p1p_p1w.fet \
        --output p1p_p1w_fet.igv
fi

echo "Pipeline complete $(date)"

